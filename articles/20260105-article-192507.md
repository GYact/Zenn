---
title: "LLMエージェントで投資ポートフォリオ最適化に挑戦し効率的な資産配分を実現する方法"
emoji: "📝"
type: "tech"
topics: ["LLM\u30a8\u30fc\u30b8\u30a7\u30f3\u30c8", "\u6295\u8cc7\u30dd\u30fc\u30c8\u30d5\u30a9\u30ea\u30aa\u6700\u9069\u5316", "\u8cc7\u7523\u914d\u5206", "\u91d1\u878d\u5de5\u5b66", "\u6a5f\u68b0\u5b66\u7fd2"]
published: true
---

```markdown
# LLMエージェントで投資ポートフォリオ最適化に挑戦し効率的な資産配分を実現する方法

## 1. はじめに：投資ポートフォリオ最適化とLLMエージェントの可能性

投資ポートフォリオ最適化は、金融工学の中でも非常にチャレンジングかつ実務的なテーマです。リスクとリターンのバランスを取りながら、効率的な資産配分を探る問題は、伝統的には数理最適化や統計的手法でアプローチされてきました。しかし近年、自然言語処理（NLP）分野で飛躍的に進化した大規模言語モデル（LLM）を活用した「LLMエージェント」が、意外な形でこの種の複雑な最適化問題に新たな可能性をもたらしています。

私自身、金融工学の専門家ではありませんが、機械学習エンジニアとしての経験を活かし、LLMエージェントで「Combinatorial Efficient Frontier Optimization（CCPO）」という難解なポートフォリオ最適化問題に挑戦しました。この記事では、実際に試行錯誤した過程とそこで得られた学びを中心に、LLMエージェントを用いた資産配分の効率化手法を具体的に解説します。

---

## 2. 課題分解：CCPO問題の理解とLLMエージェント適用時のポイント

### CCPO問題とは？

CCPO（Combinatorial Constrained Portfolio Optimization）は、投資対象の資産数が多く、かつ組み合わせ制約が複雑な場合に発生する最適化問題です。従来の効率的フロンティア理論や二次計画法では規模や制約の複雑さに対応しきれず、計算負荷や局所解の問題が顕著になります。

### なぜLLMエージェントか？

LLMエージェントは、人間のように複数のタスクを分割・統合しながら問題解決を進める点が強みです。具体的には、

- **自然言語での問題記述の解釈**
- **制約条件の抽出と再構成**
- **部分問題の分割と再帰的最適化**
- **外部ツール（数値計算ライブラリなど）との連携**

を柔軟に行えます。CCPOのように「組み合わせ的な制約」と「多目的最適化」という複雑な問題に対して、LLMエージェントの持つ「多段階推論」と「外部知識活用」の力を試す価値があると考えました。

### 私が注目したポイント

- **問題の言語的な表現に強みを持つLLMに、制約条件の複雑なロジックをどう伝えるか？**
- **LLMが生成する解答の数値的妥当性をどう検証・修正するか？**
- **計算リソースを抑えつつ、効率的に収束させるための戦略は？**

これらは、実装前に頭の中で何度も整理しました。

---

## 3. 実装の苦闘：LLMエージェントでの最適化モデル構築中に直面した問題

### 初期実装の壁

私はPythonでLLMエージェントのベースを作り、OpenAIのGPT-4 APIを利用しました。最初のトライでは、

- **制約条件の誤解釈による非現実的なポートフォリオ提案**
- **LLMの推論が長くなりすぎ、APIのトークン制限に抵触**
- **複数の部分問題を整理・統合するロジックの実装難易度**

に直面しました。

#### 具体例：制約の誤解釈

例えば、「各資産の比率は5%〜30%の範囲内で、特定の資産グループの合計は40%以下」という複雑な制約を提示したところ、LLMが「40%以下」の部分を見落とし、合計50%以上となる解を返すことが何度もありました。

```python
# 制約例（擬似コード）
constraints = {
    "asset_min": 0.05,
    "asset_max": 0.30,
    "group_max_sum": 0.40
}
```

この問題は、LLMの「記憶容量」と「論理的整合性」の限界によるもので、単にプロンプトを長くすれば解決するものではありませんでした。

### 計算検証の困難さ

LLMは自然言語生成に長けていますが、数値計算の正確性は必ずしも保証されません。そこで、私は生成結果をPythonの`cvxpy`や`numpy`で再計算・検証し、誤りがあればエージェントにフィードバックする仕組みを作りました。

しかし、このフィードバックループはAPIコール数が増え、コストとレスポンス時間の増大という別の壁にぶつかりました。

---

## 4. 転機と工夫：課題克服のために試した手法と改善点

### 1. 制約の分割・段階的適用

制約を一括で与えるのではなく、まず「資産ごとの最小・最大比率」のみを適用し、その後「グループ制約」や「全体のリスク目標」を段階的にエージェントに課す方式に変更しました。

これにより、LLMの推論負荷を軽減し、部分的に正しい解を生成しやすくなりました。

### 2. エージェントの役割分割

LLMエージェントを単一の「最適化解生成者」とせず、

- **問題分解者**（複雑な制約を整理し、部分問題を作成）
- **解候補生成者**（部分問題ごとに解を生成）
- **結果統合者**（部分解を組み合わせて全体解を検証）

に役割を分けるパイプラインを実装しました。これにより、推論の際のプロンプトが短縮され、トークン制限を回避できました。

### 3. 自動検証と再提示ループ

生成された候補をPythonコードで数値的に検証し、違反があればその理由と共にエージェントに返すループを実装。これが「身体性」の教訓にも通じる部分で、自動化しつつも人間の判断軸を加味することで精度を高めました。

```python
def verify_portfolio(portfolio, constraints):
    # 制約違反チェックの簡易例
    for asset, weight in portfolio.items():
        if not (constraints["asset_min"] <= weight <= constraints["asset_max"]):
            return False, f"Asset {asset} violates min/max constraint"
    if sum([portfolio[a] for a in group_assets]) > constraints["group_max_sum"]:
        return False, "Group sum constraint violated"
    return True, "Portfolio valid"
```

### 4. プロンプトエンジニアリングの工夫

- 制約や目的を箇条書きで明示
- 過去の失敗例（誤った解決策）をネガティブプロンプトとして提示
- 逐次的な質問形式で段階的に解を組み立てる

これらの工夫で、LLMが課題の本質を掴みやすくなりました。

---

## 5. まとめと今後の展望：今回の学びとLLMエージェント活用の可能性

### 今回の学び

- **LLMエージェントは複雑な金融最適化問題に新たなアプローチを提供できるが、万能ではない。**
- **複雑な制約は一度に与えず、分割・段階的に課すことでLLMの能力を最大限活かせる。**
- **生成結果の数値検証やフィードバックループは不可欠で、人間の介入が価値の源泉となる。**
- **役割分割を明確にし、LLMを複数のサブエージェントとして活用するパイプライン設計が効果的。**

### 今後の展望

今回の経験から、LLMエージェントは単なる言語モデル以上に「問題解決のためのマルチモーダル・マルチタスクエージェント」としての発展が期待されます。金融以外の複雑な制約付き最適化問題や、動的な市場環境に適応するリアルタイム最適化にも応用の可能性が広がるでしょう。

また、LLMと数理最適化ライブラリ（例：`cvxpy`や強化学習フレームワーク）とのハイブリッド連携を深めることで、より実用的なソリューションが生まれると確信しています。

---

## 付録：簡単なLLMエージェントによるポートフォリオ最適化のコード例（概要）

```python
from openai import OpenAI

client = OpenAI()

def create_prompt(constraints, partial_solution=None):
    prompt = f"""
    あなたは投資ポートフォリオの最適化エージェントです。
    以下の制約条件を満たすポートフォリオを提案してください。

    制約:
    - 各資産の比率は{constraints['asset_min']*100}%から{constraints['asset_max']*100}%の範囲
    - 特定グループの合計比率は{constraints['group_max_sum']*100}%以下

    もし部分解があれば考慮してください:
    {partial_solution if partial_solution else 'なし'}

    最適な資産配分をJSON形式で示してください。
    """
    return prompt

def get_portfolio(constraints):
    prompt = create_prompt(constraints)
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": prompt}]
    )
    return response.choices[0].message.content

constraints = {
    "asset_min": 0.05,
    "asset_max": 0.30,
    "group_max_sum": 0.40
}

portfolio_json = get_portfolio(constraints)
print(portfolio_json)
```

---

## 参考リンク

- [LLM Agents for Combinatorial Efficient Frontiers: Investment Portfolio Optimization (arXiv)](https://arxiv.org/abs/2601.00770v1)

---

この記事が、LLMエージェントを活用した金融最適化問題への挑戦の一助となれば幸いです。実際に手を動かし、失敗と改善を繰り返す中で見えてくる本質的な知見が、皆さんの技術的成長に繋がることを願っています。
```